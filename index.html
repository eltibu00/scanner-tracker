<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NJ3 Picking Tracker</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background-color: #f5f5f5; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; background-color: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #0066cc; font-size: 32px; margin-bottom: 30px; text-align: center; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #ddd; }
        .tab { padding: 12px 24px; background-color: #f0f0f0; border: none; cursor: pointer; font-size: 16px; border-radius: 5px 5px 0 0; transition: background-color 0.3s; }
        .tab.active { background-color: #0066cc; color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .two-column-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 20px; }
        .form-section { background-color: #f9f9f9; padding: 25px; border-radius: 5px; }
        .completion-section { background-color: #e7f3ff; padding: 25px; border-radius: 5px; }
        .section-title { font-size: 20px; font-weight: bold; color: #0066cc; margin-bottom: 20px; border-bottom: 2px solid #0066cc; padding-bottom: 10px; }
        .form-group { margin-bottom: 20px; }
        label { display: block; font-weight: bold; margin-bottom: 8px; color: #333; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
        input:focus, select:focus { outline: none; border-color: #0066cc; }
        .button-group { display: flex; gap: 15px; margin-top: 25px; }
        button { padding: 12px 30px; font-size: 16px; font-weight: bold; border: none; border-radius: 5px; cursor: pointer; transition: background-color 0.3s; }
        .btn-start { background-color: #28a745; color: white; }
        .btn-start:hover { background-color: #218838; }
        .btn-complete { background-color: #0066cc; color: white; width: 100%; }
        .btn-complete:hover { background-color: #0052a3; }
        .btn-clear { background-color: #6c757d; color: white; }
        .btn-clear:hover { background-color: #5a6268; }
        .btn-download { background-color: #17a2b8; color: white; padding: 10px 20px; font-size: 14px; margin-bottom: 15px; }
        .btn-download:hover { background-color: #138496; }
        .btn-refresh { background-color: #ffc107; color: #000; padding: 8px 16px; font-size: 14px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #0066cc; color: white; font-weight: bold; }
        tr:hover { background-color: #f5f5f5; }
        .status-badge { padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: bold; }
        .status-progress { background-color: #ffc107; color: #000; }
        .status-completed { background-color: #28a745; color: white; }
        .no-data { text-align: center; padding: 40px; color: #999; font-style: italic; }
        .error-message { background-color: #f8d7da; color: #721c24; padding: 12px; border-radius: 4px; margin-bottom: 15px; display: none; }
        .success-message { background-color: #d4edda; color: #155724; padding: 12px; border-radius: 4px; margin-bottom: 15px; display: none; }
        
        /* Chart Styles */
        .chart-container { background: #f9f9f9; padding: 25px; border-radius: 8px; margin-top: 30px; }
        .chart-title { font-size: 20px; font-weight: bold; color: #0066cc; margin-bottom: 20px; text-align: center; }
        .chart-bar-container { margin-bottom: 15px; }
        .chart-label { display: flex; justify-content: space-between; margin-bottom: 5px; font-weight: bold; color: #333; }
        .chart-bar-wrapper { background: #e0e0e0; border-radius: 5px; height: 35px; position: relative; overflow: hidden; }
        .chart-bar { background: linear-gradient(90deg, #0066cc, #0099ff); height: 100%; border-radius: 5px; display: flex; align-items: center; justify-content: flex-end; padding-right: 10px; color: white; font-weight: bold; transition: width 0.5s ease; }
        .rank-badge { display: inline-block; background: #ffc107; color: #000; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: bold; margin-right: 8px; }
        .rank-1 .chart-bar { background: linear-gradient(90deg, #FFD700, #FFA500); }
        .rank-2 .chart-bar { background: linear-gradient(90deg, #C0C0C0, #A8A8A8); }
        .rank-3 .chart-bar { background: linear-gradient(90deg, #CD7F32, #B87333); }
    </style>
</head>
<body>
    <div class="container">
        <h1>NJ3 Picking Tracker</h1>
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab('batch-operations')">Start/Complete Batch</button>
            <button class="tab" onclick="switchTab('in-progress')">In Progress</button>
            <button class="tab" onclick="switchTab('productivity')">Productivity</button>
            <button class="tab" onclick="switchTab('completed')">Completed Batches</button>
        </div>
        
        <div id="batch-operations" class="tab-content active">
            <div class="error-message" id="error-msg"></div>
            <div class="success-message" id="success-msg"></div>
            
            <div class="two-column-layout">
                <div class="form-section">
                    <div class="section-title">ðŸŸ¢ START NEW BATCH</div>
                    <div class="form-group">
                        <label for="batchId">Batch/Pull ID:</label>
                        <input type="text" id="batchId" placeholder="Scan or enter Batch/Pull ID">
                    </div>
                    <div class="form-group">
                        <label for="account">Account:</label>
                        <select id="account">
                            <option value="">Select Account</option>
                            <option value="BAM">BAM</option>
                            <option value="BR">BR</option>
                            <option value="It's Work">It's Work</option>
                            <option value="KA">KA</option>
                            <option value="Maely's Ecom">Maely's Ecom</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="employeeId">Employee ID/Name:</label>
                        <input type="text" id="employeeId" placeholder="Scan or enter Employee ID or Name">
                    </div>
                    <div class="form-group">
                        <label for="batchQty">Batch Quantity:</label>
                        <input type="number" id="batchQty" placeholder="Enter batch quantity">
                    </div>
                    <div class="form-group">
                        <label for="skuCount">SKU Count (Lines):</label>
                        <input type="number" id="skuCount" placeholder="Enter SKU count">
                    </div>
                    <div class="button-group">
                        <button class="btn-start" onclick="startBatch()">Start Batch</button>
                        <button class="btn-clear" onclick="clearForm()">Clear Form</button>
                    </div>
                </div>
                
                <div class="completion-section">
                    <div class="section-title">ðŸ”µ COMPLETE BATCH</div>
                    <div class="form-group">
                        <label for="completeBatchId">Scan Batch/Pull ID:</label>
                        <input type="text" id="completeBatchId" placeholder="Scan Batch/Pull ID to complete">
                    </div>
                    <div class="form-group">
                        <label for="completeException">Exception (if any):</label>
                        <select id="completeException">
                            <option value="">No Exception</option>
                            <option value="Short Picked">Short Picked</option>
                            <option value="Damaged Item">Damaged Item</option>
                            <option value="Item Not Found">Item Not Found</option>
                            <option value="Wrong Location">Wrong Location</option>
                        </select>
                    </div>
                    <button class="btn-complete" onclick="completeBatchQuick()">Complete Batch</button>
                    <div style="margin-top: 30px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <h3 style="color: #333;">In Progress Batches:</h3>
                            <button class="btn-refresh" onclick="loadInProgressBatches()">ðŸ”„ Refresh</button>
                        </div>
                        <div id="quick-progress-list"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="in-progress" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h2>In Progress Batches</h2>
                <button class="btn-refresh" onclick="loadInProgressBatches()">ðŸ”„ Refresh</button>
            </div>
            <div id="in-progress-list"></div>
        </div>
        
        <div id="productivity" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>Daily Productivity by Employee</h2>
                <div>
                    <button class="btn-refresh" onclick="loadCompletedBatches()">ðŸ”„ Refresh</button>
                    <button class="btn-download" onclick="downloadProductivity()">ðŸ“Š Download to Excel</button>
                </div>
            </div>
            
            <!-- PERFORMANCE CHART -->
            <div class="chart-container" id="performance-chart-container">
                <div class="chart-title">ðŸ“Š Lines Per Hour Ranking (Today)</div>
                <div id="performance-chart"></div>
            </div>
        </div>
        
        <div id="completed" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>Completed Batches Archive</h2>
                <div>
                    <button class="btn-refresh" onclick="loadCompletedBatches()">ðŸ”„ Refresh</button>
                    <button class="btn-download" onclick="downloadCompleted()">ðŸ“Š Download to Excel</button>
                </div>
            </div>
            <div id="completed-list"></div>
        </div>
    </div>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyeeTEiujbAP4UR--RGnCpJmS3JXQ1rSO08xSH4bn9Hm3kw5I9JbJSK7DE49x_V-CL9QQ/exec';
        let inProgressBatches = [];
        let completedBatches = [];
        
        window.addEventListener('load', function() {
            loadInProgressBatches();
            loadCompletedBatches();
        });
        
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            if (tabName === 'in-progress') loadInProgressBatches();
            else if (tabName === 'completed' || tabName === 'productivity') loadCompletedBatches();
        }
        
        function showError(message) {
            const errorMsg = document.getElementById('error-msg');
            errorMsg.textContent = message;
            errorMsg.style.display = 'block';
            setTimeout(() => errorMsg.style.display = 'none', 5000);
        }
        
        function showSuccess(message) {
            const successMsg = document.getElementById('success-msg');
            successMsg.textContent = message;
            successMsg.style.display = 'block';
            setTimeout(() => successMsg.style.display = 'none', 3000);
        }
        
        // Helper function to format dates properly on the client side
        function formatDisplayDate(dateValue) {
            if (!dateValue) return '-';
            
            // If already formatted (contains AM/PM), return as is
            if (typeof dateValue === 'string' && (dateValue.includes('AM') || dateValue.includes('PM'))) {
                return dateValue;
            }
            
            // Try to parse the date
            let d;
            if (typeof dateValue === 'string') {
                d = new Date(dateValue);
            } else {
                d = new Date(dateValue);
            }
            
            // Check if valid date
            if (isNaN(d.getTime())) return String(dateValue);
            
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            const year = d.getFullYear();
            let hours = d.getHours();
            const minutes = String(d.getMinutes()).padStart(2, '0');
            const ampm = hours >= 12 ? 'PM' : 'AM';
            hours = hours % 12;
            hours = hours ? hours : 12;
            
            return `${month}/${day}/${year} ${hours}:${minutes} ${ampm}`;
        }
        
        async function startBatch() {
            const batchId = document.getElementById('batchId').value.trim();
            const account = document.getElementById('account').value;
            const employeeId = document.getElementById('employeeId').value.trim();
            const batchQty = document.getElementById('batchQty').value;
            const skuCount = document.getElementById('skuCount').value;
            
            if (!batchId || !account || !employeeId || !batchQty || !skuCount) {
                showError('Please fill in all fields');
                return;
            }
            
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'startBatch',
                        batchId, account, employeeId,
                        qty: batchQty, skuCount
                    })
                });
                const result = await response.json();
                if (result.error) showError(result.error);
                else {
                    showSuccess('Batch ' + batchId + ' started successfully!');
                    clearForm();
                    loadInProgressBatches();
                }
            } catch (error) {
                showError('Error starting batch: ' + error.message);
            }
        }
        
        async function completeBatchQuick() {
            const batchId = document.getElementById('completeBatchId').value.trim();
            const exception = document.getElementById('completeException').value;
            if (!batchId) {
                showError('Please scan a Batch/Pull ID');
                return;
            }
            
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'completeBatch', 
                        batchId,
                        exception
                    })
                });
                const result = await response.json();
                if (result.error) showError(result.error);
                else {
                    showSuccess('Batch ' + batchId + ' completed successfully!');
                    document.getElementById('completeBatchId').value = '';
                    document.getElementById('completeException').value = '';
                    loadInProgressBatches();
                    loadCompletedBatches();
                }
            } catch (error) {
                showError('Error completing batch: ' + error.message);
            }
        }
        
        async function loadInProgressBatches() {
            try {
                const timestamp = new Date().getTime();
                const response = await fetch(SCRIPT_URL + '?action=getInProgress&t=' + timestamp);
                inProgressBatches = await response.json();
                displayQuickProgressList();
                displayInProgressBatches();
            } catch (error) {
                console.error('Error loading batches:', error);
            }
        }
        
        async function loadCompletedBatches() {
            try {
                const timestamp = new Date().getTime();
                const response = await fetch(SCRIPT_URL + '?action=getCompleted&t=' + timestamp);
                completedBatches = await response.json();
                displayCompletedBatches();
                loadProductivityChart();
            } catch (error) {
                console.error('Error loading batches:', error);
            }
        }
        
        async function loadProductivityChart() {
            try {
                const timestamp = new Date().getTime();
                const response = await fetch(SCRIPT_URL + '?action=getProductivityChart&t=' + timestamp);
                const chartData = await response.json();
                
                // Check if it's actually an array before using it
                if (Array.isArray(chartData)) {
                    displayProductivityChart(chartData);
                } else {
                    console.error('Chart data error:', chartData);
                    displayProductivityChart([]);
                }
            } catch (error) {
                console.error('Error loading chart:', error);
                displayProductivityChart([]);
            }
        }
        
        function displayProductivityChart(data) {
            const container = document.getElementById('performance-chart');
            if (!data || data.length === 0) {
                container.innerHTML = '<div class="no-data">No productivity data available yet</div>';
                return;
            }
            
            // Find max for scaling
            const maxLines = Math.max(...data.map(d => d.linesPerHour));
            
            let html = '';
            data.forEach((item, index) => {
                const rank = index + 1;
                const percentage = maxLines > 0 ? (item.linesPerHour / maxLines) * 100 : 0;
                const rankClass = rank <= 3 ? 'rank-' + rank : '';
                
                html += '<div class="chart-bar-container ' + rankClass + '">';
                html += '<div class="chart-label">';
                html += '<span><span class="rank-badge">#' + rank + '</span>' + item.employee + '</span>';
                html += '<span>' + item.linesPerHour + ' lines/hour (' + item.batches + ' batches)</span>';
                html += '</div>';
                html += '<div class="chart-bar-wrapper">';
                html += '<div class="chart-bar" style="width: ' + percentage + '%">' + item.linesPerHour + '</div>';
                html += '</div>';
                html += '</div>';
            });
            
            container.innerHTML = html;
        }
        
        function clearForm() {
            document.getElementById('batchId').value = '';
            document.getElementById('account').value = '';
            document.getElementById('employeeId').value = '';
            document.getElementById('batchQty').value = '';
            document.getElementById('skuCount').value = '';
        }
        
        function displayQuickProgressList() {
            const container = document.getElementById('quick-progress-list');
            if (inProgressBatches.length === 0) {
                container.innerHTML = '<div style="color: #999; font-style: italic; margin-top: 10px;">No batches in progress</div>';
                return;
            }
            let html = '<div style="max-height: 300px; overflow-y: auto; margin-top: 10px;">';
            inProgressBatches.forEach(batch => {
                html += '<div style="background: white; padding: 10px; margin-bottom: 8px; border-radius: 4px; border: 1px solid #ddd;">';
                html += '<strong>' + batch.batchId + '</strong> - ' + batch.account + '<br>';
                html += '<small>' + batch.employeeId + ' | Qty: ' + batch.qty + ' | Lines: ' + batch.skuCount + '</small></div>';
            });
            html += '</div>';
            container.innerHTML = html;
        }
        
        function displayInProgressBatches() {
            const container = document.getElementById('in-progress-list');
            if (inProgressBatches.length === 0) {
                container.innerHTML = '<div class="no-data">No batches in progress</div>';
                return;
            }
            let html = '<table><thead><tr><th>Batch ID</th><th>Account</th><th>Employee</th><th>Start Time</th><th>Qty</th><th>Lines</th><th>Status</th></tr></thead><tbody>';
            inProgressBatches.forEach(batch => {
                html += '<tr><td><strong>' + batch.batchId + '</strong></td><td>' + batch.account + '</td><td>' + batch.employeeId + '</td><td>' + formatDisplayDate(batch.startTimeDisplay) + '</td><td>' + batch.qty + '</td><td>' + batch.skuCount + '</td><td><span class="status-badge status-progress">In Progress</span></td></tr>';
            });
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        // Auto-uppercase Batch IDs for consistency
        document.getElementById('completeBatchId').addEventListener('input', function(e) {
            this.value = this.value.toUpperCase();
        });

        document.getElementById('batchId').addEventListener('input', function(e) {
            this.value = this.value.toUpperCase();
        });
        
        function displayCompletedBatches() {
            const container = document.getElementById('completed-list');
            if (completedBatches.length === 0) {
                container.innerHTML = '<div class="no-data">No completed batches</div>';
                return;
            }
            let html = '<table><thead><tr><th>Batch ID</th><th>Account</th><th>Employee</th><th>Start Time</th><th>End Time</th><th>Duration</th><th>Qty</th><th>Lines</th><th>Exception</th><th>Status</th></tr></thead><tbody>';
            completedBatches.forEach(batch => {
                html += '<tr><td><strong>' + batch.batchId + '</strong></td><td>' + batch.account + '</td><td>' + batch.employeeId + '</td><td>' + formatDisplayDate(batch.startTimeDisplay) + '</td><td>' + formatDisplayDate(batch.endTimeDisplay) + '</td><td>' + batch.durationDisplay + '</td><td>' + batch.qty + '</td><td>' + batch.skuCount + '</td><td>' + (batch.exception || '-') + '</td><td><span class="status-badge status-completed">Completed</span></td></tr>';
            });
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        function downloadCompleted() {
            if (completedBatches.length === 0) { alert('No completed batches to download'); return; }
            let csv = 'Batch ID,Account,Employee,Start Time,End Time,Duration (min),Quantity,Lines,Exception,Status\n';
            completedBatches.forEach(batch => {
                csv += '"' + batch.batchId + '","' + batch.account + '","' + batch.employeeId + '","' + formatDisplayDate(batch.startTimeDisplay) + '","' + formatDisplayDate(batch.endTimeDisplay) + '",' + batch.duration + ',' + batch.qty + ',' + batch.skuCount + ',"' + (batch.exception || '') + '","' + batch.status + '"\n';
            });
            downloadCSV(csv, 'NJ3_Completed_Batches.csv');
        }
        
        function downloadProductivity() {
            if (completedBatches.length === 0) { alert('No productivity data to download'); return; }
            const productivityData = {};
            completedBatches.forEach(batch => {
                const key = batch.completionDate + '_' + batch.employeeId;
                if (!productivityData[key]) {
                    productivityData[key] = { date: batch.completionDate, employee: batch.employeeId, totalBatches: 0, totalQty: 0, totalLines: 0, totalDuration: 0, exceptions: 0 };
                }
                productivityData[key].totalBatches++;
                productivityData[key].totalQty += parseInt(batch.qty) || 0;
                productivityData[key].totalLines += parseInt(batch.skuCount) || 0;
                productivityData[key].totalDuration += parseInt(batch.duration) || 0;
                if (batch.exception) productivityData[key].exceptions++;
            });
            let csv = 'Date,Employee,Batches,Total Qty,Total Lines,Total Min,Avg Min/Batch,Qty/Hour,Lines/Hour,Exceptions\n';
            Object.values(productivityData).forEach(data => {
                const avgDuration = data.totalBatches > 0 ? Math.round(data.totalDuration / data.totalBatches) : 0;
                const qtyPerHour = data.totalDuration > 0 ? Math.round((data.totalQty / data.totalDuration) * 60) : 0;
                const linesPerHour = data.totalDuration > 0 ? Math.round((data.totalLines / data.totalDuration) * 60) : 0;
                csv += '"' + data.date + '","' + data.employee + '",' + data.totalBatches + ',' + data.totalQty + ',' + data.totalLines + ',' + data.totalDuration + ',' + avgDuration + ',' + qtyPerHour + ',' + linesPerHour + ',' + data.exceptions + '\n';
            });
            downloadCSV(csv, 'NJ3_Productivity_Report.csv');
        }
        
        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
        }
        
        document.getElementById('completeBatchId').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') completeBatchQuick();
        });
    </script>
</body>
</html>
